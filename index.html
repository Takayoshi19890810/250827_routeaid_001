<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å®Ÿè»Šè©•ä¾¡æ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
<link rel="stylesheet" href="leaflet.css" />
<style>
  html,body{height:100%;margin:0}
  #map{position:fixed; inset:0; background:#f2f2f2; transform-origin:center center; z-index:0;}
  #panel{
    position:fixed; left:10px; top:calc(10px + env(safe-area-inset-top));
    z-index:2147483000; background:#fff; padding:10px 12px; border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.18); font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    min-width:300px; max-width:min(94vw,560px);
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
  }
  /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼éè¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
  #panel.hidden {
    opacity: 0;
    pointer-events: none;
    transform: translateX(-100px);
  }
  #panel h1{margin:0 0 8px;font-size:15px;font-weight:700}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  .row>label{white-space:nowrap}
  .small{font-size:11px;color:#555}
  .grow{flex:1 1 auto;min-width:140px}
  button{padding:10px 14px; min-height:40px; border-radius:12px; cursor:pointer; border:1px solid #ddd; background:#fff;}
  select, input[type=range]{height:40px;border-radius:10px;border:1px solid #ddd;padding:0 8px}
  #start{background:#16a34a;color:#fff;border-color:#16a34a}
  #stop{background:#ef4444;color:#fff;border-color:#ef4444}
  #recenter{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  #cp{background:#f59e0b;color:#fff;border-color:#f59e0b}
  #saveGpx{background:#6366f1;color:#fff;border-color:#6366f1}
  #fabStop{position:fixed; right:calc(12px + env(safe-area-inset-right)); bottom:calc(12px + env(safe-area-inset-bottom));
    z-index:2147483200; display:none; width:84px;height:84px;border-radius:50%; box-shadow:0 12px 36px rgba(0,0,0,.28);
    border:none; background:#ef4444;color:#fff;font-size:16px;font-weight:700;}
  #recBadge{position:fixed; right:12px; top:calc(12px + env(safe-area-inset-top)); z-index:2147483200; display:none; align-items:center; gap:6px;
    background:rgba(239,68,68,.95); color:#fff; padding:6px 10px; border-radius:9999px; box-shadow:0 6px 24px rgba(0,0,0,.18); font-size:12px}
  .dot{width:10px;height:10px;border-radius:50%;background:#fff;animation:blink 1s infinite}
  @keyframes blink{0%,60%{opacity:1}61%,100%{opacity:0}}
  /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
  #menu-toggle {
    position: fixed; right: 12px; bottom: 12px; z-index: 2147483200;
    width: 60px; height: 60px; border-radius: 50%;
    background: #fff; color: #000; font-size: 24px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 6px 24px rgba(0,0,0,.18);
  }
</style>
<script src="leaflet.js"></script>
<script src="jszip.min.js"></script>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <h1>å®Ÿè»Šè©•ä¾¡æ”¯æ´ãƒ„ãƒ¼ãƒ«</h1>
  <div class="row">
    <label for="file">ãƒ«ãƒ¼ãƒˆ/ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆèª­è¾¼:</label>
    <input type="file" id="file" accept=".gpx,.kml,application/vnd.google-earth.kmz" />
  </div>
  <div class="row">
    <button id="start">â–¶ è¿½è·¡é–‹å§‹</button>
    <button id="stop" disabled>â–  è¿½è·¡åœæ­¢</button>
    <button id="cp">ğŸ“Œ CP</button>
  </div>
  <div class="row">
    <button id="recenter">ç¾åœ¨åœ°ã¸</button>
    <button id="saveGpx">GPXä¿å­˜</button> 
  </div>
</div>
<button id="fabStop">åœæ­¢</button>
<div id="recBadge"><span class="dot"></span> REC</div>
<button id="menu-toggle">âš™</button>

<script>
  'use strict';

  /* ==== å®šæ•°ãƒ»å¤‰æ•° ==== */
  const mapElem = document.getElementById('map');
  const fileInput = document.getElementById('file');
  const startBtn = document.getElementById('start');
  const stopBtn = document.getElementById('stop');
  const fabStopBtn = document.getElementById('fabStop');
  const cpBtn = document.getElementById('cp');
  const recenterBtn = document.getElementById('recenter');
  const saveGpxBtn = document.getElementById('saveGpx');
  const recBadge = document.getElementById('recBadge');
  const panel = document.getElementById('panel');
  const menuToggleBtn = document.getElementById('menu-toggle'); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³

  let map;
  let trackControl; // ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€ãã®ã¾ã¾æ®‹ã—ã¾ã™
  let lineFeature;
  let cpMarkers;
  let trackLine;

  const cpIcon = L.icon({
    iconUrl: './images/marker-icon-orange.png',
    iconRetinaUrl: './images/marker-icon-orange-2x.png',
    shadowUrl: './images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    tooltipAnchor: [16, -28],
    shadowSize: [41, 41],
  });

  const voice = new SpeechSynthesisUtterance();
  voice.lang = 'ja-JP';

  // GPXã®ãƒˆãƒ©ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
  let track = {
    metadata: { name: 'Track' },
    tracks: [{
      name: '',
      segments: [{
        points: []
      }]
    }]
  };
  let trackWatchId;

  /* ==== åˆæœŸåŒ– ==== */
  window.addEventListener('load', () => {
    map = L.map(mapElem, {
      center: [35.6812, 139.7671], // æ±äº¬é§…
      zoom: 13,
      zoomControl: false,
    });
    L.control.zoom({ position: 'topright' }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19,
    }).addTo(map);

    // GPXã®ãƒˆãƒ©ãƒƒã‚¯ãƒ©ã‚¤ãƒ³
    trackLine = L.polyline([], { color: '#0070c0', weight: 6, opacity: 0.7 }).addTo(map);
    // CPãƒãƒ¼ã‚«ãƒ¼ãƒ¬ã‚¤ãƒ¤ãƒ¼
    cpMarkers = L.featureGroup().addTo(map);
    // èª­ã¿è¾¼ã‚“ã ãƒ«ãƒ¼ãƒˆç·š
    lineFeature = L.geoJSON(null, {
      style: { color: '#ef4444', weight: 6, opacity: 0.7 },
    }).addTo(map);

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 17);
      }, () => {
        alert('ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
      });
    }
    
    // ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ç™»éŒ²
    if(navigator.serviceWorker){
      navigator.serviceWorker.register('sw.js').then(reg=>{
        if(reg.waiting){ reg.waiting.postMessage({type:'SKIP_WAITING'}); }
        reg.addEventListener('updatefound',()=> {
          const sw=reg.installing; sw?.addEventListener('statechange',()=> {
            if(sw.state==='installed'){ reg.waiting?.postMessage({type:'SKIP_WAITING'}); }
          });
        });
      });
    }
  });

  /* ==== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ==== */
  fileInput.addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    // KMZãƒ•ã‚¡ã‚¤ãƒ«ã‚’Zipã¨ã—ã¦å‡¦ç†
    if (file.name.toLowerCase().endsWith('.kmz')) {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const zip = new JSZip();
        await zip.loadAsync(arrayBuffer);
        const kmlFile = zip.file(/\.kml$/i)[0]; // .kmlãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™

        if (kmlFile) {
          const kmlText = await kmlFile.async('text');
          const parser = new DOMParser();
          const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
          // KMLå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ (toGeoJSONãŒä¸è¦ã«ãªã£ãŸãŸã‚ã€kmlå‡¦ç†ã¯ã“ã“ã§ã¯çœç•¥ã—ã¾ã™)
          alert('KMZãƒ•ã‚¡ã‚¤ãƒ«å†…ã®KMLãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ã¯åˆ¥é€”å®Ÿè£…ãŒå¿…è¦ã§ã™ã€‚');
        } else {
          alert('KMZãƒ•ã‚¡ã‚¤ãƒ«å†…ã«KMLãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        }
      } catch (e) {
        console.error("KMZå‡¦ç†ã‚¨ãƒ©ãƒ¼:", e);
        alert('KMZãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      }
    } else {
      // KML/GPXãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å‡¦ç† (toGeoJSONãŒä¸è¦ã«ãªã£ãŸãŸã‚ã€ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ã¯åˆ¥é€”å®Ÿè£…ãŒå¿…è¦ã§ã™)
      const reader = new FileReader();
      reader.onload = () => {
        // XMLå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯... (ã“ã“ã§ã¯çœç•¥)
        alert('GPX/KMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ã¯åˆ¥é€”å®Ÿè£…ãŒå¿…è¦ã§ã™ã€‚');
      };
      reader.readAsText(file);
    }
  });

  startBtn.addEventListener('click', () => {
    if (trackWatchId) return;

    // ãƒˆãƒ©ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
    track.tracks[0].segments[0].points = [];
    track.tracks[0].name = `Track-${new Date().toISOString()}`;
    trackLine.setLatLngs([]);
    startBtn.disabled = true;
    stopBtn.disabled = false;
    fabStopBtn.style.display = 'block';
    recBadge.style.display = 'flex';

    if (navigator.geolocation) {
      trackWatchId = navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude, altitude, speed, heading } = pos.coords;
        const point = {
          lat: latitude,
          lon: longitude,
          ele: altitude,
          time: new Date().toISOString(),
          speed: speed,
          heading: heading,
        };
        track.tracks[0].segments[0].points.push(point);
        trackLine.addLatLng([latitude, longitude]);
        map.setView([latitude, longitude]);
      }, null, { enableHighAccuracy: true });
    }
  });

  stopBtn.addEventListener('click', () => {
    if (!trackWatchId) return;
    navigator.geolocation.clearWatch(trackWatchId);
    trackWatchId = null;

    startBtn.disabled = false;
    stopBtn.disabled = true;
    fabStopBtn.style.display = 'none';
    recBadge.style.display = 'none';

    // è¿½è·¡çµ‚äº†æ™‚ã«ä¿å­˜ã‚’ç¢ºèªã™ã‚‹å‡¦ç†
    if (confirm('è¿½è·¡çµ‚äº†æ™‚ã«GPXã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) {
        let fileName = prompt('ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'track.gpx');
        if (fileName) {
            if (!fileName.toLowerCase().endsWith('.gpx')) {
                fileName += '.gpx';
            }
            saveGpxFile(fileName);
        }
    }
  });

  fabStopBtn.addEventListener('click', () => {
    stopBtn.click();
  });

  recenterBtn.addEventListener('click', () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 17);
      });
    }
  });
  
  cpBtn.addEventListener('click', () => {
    if (!trackWatchId) {
      alert('è¿½è·¡ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      const marker = L.marker([latitude, longitude], { icon: cpIcon }).addTo(cpMarkers);
      marker.bindTooltip('CP', { permanent: true, direction: 'top' });
    });
  });

  // GPXä¿å­˜ãƒœã‚¿ãƒ³ã®æ©Ÿèƒ½ï¼ˆä»»æ„ä¿å­˜ç”¨ï¼‰
  saveGpxBtn.addEventListener('click', () => {
    let fileName = prompt('ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'track.gpx');
    if (fileName) {
        if (!fileName.toLowerCase().endsWith('.gpx')) {
            fileName += '.gpx';
        }
        saveGpxFile(fileName);
    } else {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«åãŒå…¥åŠ›ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
    }
  });

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º/éè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
  menuToggleBtn.addEventListener('click', () => {
    panel.classList.toggle('hidden');
    // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚‚åˆ‡ã‚Šæ›¿ãˆãŸã„å ´åˆã¯ã€ã“ã“ã§å‡¦ç†ã‚’è¿½åŠ 
    // menuToggleBtn.textContent = panel.classList.contains('hidden') ? 'â˜°' : 'âš™'; 
  });

  /* ==== GPXä¿å­˜æ©Ÿèƒ½ ==== */
  function saveGpxFile(fileName) {
    // èµ°è¡Œãƒ‡ãƒ¼ã‚¿ã‚’GPXãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
    const text = `<gpx version="1.1" creator="Route-Aid" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd"><trk><name>${escapeHTML(track.tracks[0].name)}</name><trkseg>${track.tracks[0].segments[0].points.map(p => `<trkpt lat="${p.lat}" lon="${p.lon}"><time>${p.time}</time>${p.ele?`<ele>${p.ele}</ele>`:''}${p.speed?`<speed>${p.speed}</speed>`:''}${p.heading?`<geoloc:direction>${p.heading}</geoloc:direction>`:''}</trkpt>`).join('')}</trkseg></trk></gpx>`;
    
    try{
      const blob = new Blob([text], {type:'application/gpx+xml'});
      const isiOS = /(iPhone|iPad|iPod)/i.test(navigator.userAgent);

      // iOSå¯¾å¿œ
      if(isiOS){
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(blobUrl), 4000);
        return;
      }

      // ãã®ä»–ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œ
      const opened = window.open('', '_blank');
      if (opened) {
          const url = URL.createObjectURL(blob);
          const a = opened.document.createElement('a');
          a.href = url;
          a.download = fileName;
          a.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
          a.style.display = 'block';
          a.style.textAlign = 'center';
          a.style.fontSize = '2rem';
          opened.document.body.appendChild(a);
          a.click();
          setTimeout(() => {
              URL.revokeObjectURL(url);
              opened.close();
          }, 4000);
      } else {
          // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã®ä»£æ›¿ç­–
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          a.remove();
      }
    }catch(e){
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
  }

  // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, function(match) {
      const escape = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      };
      return escape[match];
    });
  }
</script>
</body>
</html>
