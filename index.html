<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å®Ÿè»Šè©•ä¾¡æ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
<link rel="stylesheet" href="leaflet.css" />
<style>
  html,body,#map{height:100%;margin:0}
  #map{background:#f2f2f2; transform-origin:center center;} /* å›è»¢ã®åŸºç‚¹ */
  #panel{
    position:absolute;left:10px;top:10px;z-index:1000;
    background:#fff;padding:10px 12px;border-radius:14px;
    box-shadow:0 6px 24px rgba(0,0,0,.18);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    min-width:300px;max-width:min(94vw,520px)
  }
  #panel h1{margin:0 0 8px;font-size:14px;font-weight:700}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  .row > label{white-space:nowrap}
  .small{font-size:11px;color:#555}
  button{padding:6px 10px;border-radius:10px;cursor:pointer;border:1px solid #ddd;background:#fff}
  #track{background:#16a34a;color:#fff;border-color:#16a34a}
  #stop{background:#ef4444;color:#fff;border-color:#ef4444}
  #recenter{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  #checkpoint{background:#f59e0b;color:#fff;border-color:#f59e0b}
  #export{background:#6366f1;color:#fff;border-color:#6366f1}
  #fab-recenter{
    position:absolute;right:14px;bottom:14px;z-index:1000;
    width:50px;height:50px;border-radius:50%;
    display:grid;place-items:center;background:#0ea5e9;color:#fff;
    font-size:20px;border:none;box-shadow:0 6px 24px rgba(0,0,0,.18)
  }
  #recBadge{
    position:absolute;right:12px;top:12px;z-index:1001;display:none;align-items:center;gap:6px;
    background:rgba(239,68,68,.95);color:#fff;padding:6px 10px;border-radius:9999px;
    box-shadow:0 6px 24px rgba(0,0,0,.18);font-size:12px
  }
  .dot{width:10px;height:10px;border-radius:50%;background:#fff;animation:blink 1s infinite}
  @keyframes blink{0%,60%{opacity:1}61%,100%{opacity:.25}}
  #toast{
    position:absolute;left:50%;bottom:78px;transform:translateX(-50%);
    z-index:1002;display:none;max-width:min(92vw,520px);
    background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.35);font-size:14px
  }
  /* ã‚³ãƒ³ãƒ‘ã‚¹ï¼ˆCourse Up ã®ã¨ãã«æ–¹ä½ã‚’ç¤ºã™ï¼‰ */
  #compass{
    position:absolute;right:14px;top:74px;z-index:1000;
    width:44px;height:44px;border-radius:50%;background:#fff;
    box-shadow:0 4px 12px rgba(0,0,0,.2); display:grid;place-items:center;
    font-size:12px;color:#111;
  }
  #compassArrow{width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:14px solid #ef4444;transform-origin:50% 90%}
</style>
</head>
<body>
<div id="map"></div>
<div id="recBadge"><span class="dot"></span>è¿½è·¡ä¸­</div>
<div id="toast"></div>
<div id="compass" style="display:none">
  <div id="compassArrow"></div>
  <div style="font-size:10px;margin-top:2px">N</div>
</div>

<div id="panel">
  <h1>å®Ÿè»Šè©•ä¾¡æ”¯æ´ãƒ„ãƒ¼ãƒ«</h1>

  <div class="row">
    <input id="file" type="file" accept=".kml,.kmz,application/vnd.google-earth.kml+xml,application/vnd.google-earth.kmz" />
    <button id="clear">ã‚¯ãƒªã‚¢</button>
    <span id="fname" class="small">ï¼ˆæœªé¸æŠï¼‰</span>
  </div>

  <div class="row">
    <button id="track">è¿½è·¡é–‹å§‹</button>
    <button id="stop" disabled>åœæ­¢</button>
    <button id="recenter">ç¾åœ¨åœ°ã¸</button>
  </div>

  <div class="row">
    <button id="checkpoint">ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ</button>
    <label><input type="checkbox" id="withMemo" />ãƒ¡ãƒ¢å…¥åŠ›</label>
  </div>

  <div class="row">
    <label>é€šçŸ¥è·é›¢: <span id="thv">100m</span></label>
    <input id="th" type="range" min="20" max="300" step="10" value="100" />
  </div>

  <div class="row">
    <label><input type="checkbox" id="keepCentered" />è‡ªè»Šã‚’å¸¸ã«ä¸­å¿ƒ</label>
    <span class="small">ï¼ˆONã§è¿½è·¡ä¸­ã¯è‡ªè»Šã‚’ä¸­å¤®ã«å›ºå®šï¼‰</span>
  </div>

  <div class="row" style="gap:14px">
    <label>åœ°å›³ã®å‘ã:</label>
    <label><input type="radio" name="orient" value="north" checked /> åŒ—ã‚’ä¸Š</label>
    <label><input type="radio" name="orient" value="course" /> é€²è¡Œæ–¹å‘ã‚’ä¸Š</label>
  </div>

  <div class="row">
    <button id="export">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <span id="stat" class="small"></span>
  </div>

  <div class="row">
    <button id="tts">éŸ³å£°ãƒ†ã‚¹ãƒˆ</button>
    <button id="keepAwake">ç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢: OFF</button>
  </div>
</div>

<button id="fab-recenter">ğŸ“</button>

<script src="leaflet.js"></script>

<!-- ãƒ”ãƒ³ï¼šé’=æ„å‘³ã®ã‚ã‚‹KMLãƒã‚¤ãƒ³ãƒˆ / ç°=ãƒ«ãƒ¼ãƒˆæ±ç”¨ãƒ”ãƒ³ / æ©™=æ‰‹å‹•CP -->
<script>
(function(){
  function svg(color){return encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="36" viewBox="0 0 24 36">
      <path d="M12 36s10-12.2 10-20A10 10 0 1 0 2 16c0 7.8 10 20 10 20z" fill="${color}"/>
      <circle cx="12" cy="12" r="4.5" fill="#fff"/></svg>`
  );}
  const Blue   = L.Icon.extend({options:{iconUrl:`data:image/svg+xml;charset=UTF-8,${svg('#2A7FFF')}`, iconSize:[24,36],iconAnchor:[12,34],popupAnchor:[0,-30]}});
  const Orange = L.Icon.extend({options:{iconUrl:`data:image/svg+xml;charset=UTF-8,${svg('#F59E0B')}`, iconSize:[24,36],iconAnchor:[12,34],popupAnchor:[0,-30]}});
  const Gray   = L.Icon.extend({options:{iconUrl:`data:image/svg+xml;charset=UTF-8,${svg('#9CA3AF')}`, iconSize:[24,36],iconAnchor:[12,34],popupAnchor:[0,-30]}});
  // æ—¢å®šã¯é’ï¼ˆæ„å‘³ã®ã‚ã‚‹ãƒã‚¤ãƒ³ãƒˆï¼‰
  L.Marker.prototype.options.icon = new Blue();
  window.__BlueIcon   = new Blue();
  window.__OrangeIcon = new Orange();
  window.__GrayIcon   = new Gray();
})();
</script>

<script src="jszip.min.js"></script>
<script src="togeojson.umd.js"></script>

<script>
/* ====== åœ°å›³ ====== */
const map=L.map('map').setView([35,135],14);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
const me=L.circleMarker([35,135],{radius:7,color:'#0ea5e9',fillOpacity:0.7,weight:3}).addTo(map);
/* è»Œè·¡ã¯èµ¤ */
const trackLine=L.polyline([], {color:'#ef4444',weight:5}).addTo(map);
const checkpointLayer=L.layerGroup().addTo(map);

/* ====== çŠ¶æ…‹ãƒ»DOM ====== */
let lastLatLng=null, prevLatLng=null, tracking=false, watchId=null, pulseTimer=null, startupSweepTimer=null;
let notifyMeters=100;
let routeLayer=null;
const routePointLayers=[];        // èª­ã¿ä¸Šã’å¯¾è±¡ãƒã‚¤ãƒ³ãƒˆã®ã¿
const genericPointLayers=[];      // ãƒ«ãƒ¼ãƒˆæ±ç”¨ãƒ”ãƒ³ï¼ˆè¡¨ç¤ºã®ã¿ãƒ»èª­ã¿ä¸Šã’å¯¾è±¡å¤–ï¼‰

const $file=document.getElementById('file'),$clear=document.getElementById('clear'),$fname=document.getElementById('fname');
const $track=document.getElementById('track'),$stop=document.getElementById('stop');
const $rec=document.getElementById('recenter'),$fab=document.getElementById('fab-recenter');
const $chk=document.getElementById('checkpoint'),$memo=document.getElementById('withMemo');
const $th=document.getElementById('th'),$thv=document.getElementById('thv'),$stat=document.getElementById('stat');
const $recBadge=document.getElementById('recBadge'),$toast=document.getElementById('toast');
const $keepAwake=document.getElementById('keepAwake');
const $keepCentered=document.getElementById('keepCentered');
const $compass=document.getElementById('compass'); const $compassArrow=document.getElementById('compassArrow');
let orientationMode='north'; // 'north' | 'course'
document.querySelectorAll('input[name=orient]').forEach(r=>{
  r.addEventListener('change',()=>{
    orientationMode=r.value;
    if(orientationMode==='north'){
      rotateMap(0); $compass.style.display='none';
    }else{
      $compass.style.display='grid';
    }
  });
});

/* ====== éŸ³å£°ï¼ˆiOSå®‰å®šåŒ–ï¼‰ï¼‹ã‚­ãƒ¥ãƒ¼ï¼ˆonendé€£çµï¼‰ ====== */
let voiceReady=false, audioCtx=null;
function getCtx(){ return audioCtx ||= new (window.AudioContext||window.webkitAudioContext)(); }
function ensureAudio(){ try{ getCtx().resume(); }catch(_){} }
function unlockTTS(){ try{ ensureAudio(); const c=getCtx(),o=c.createOscillator(),g=c.createGain(); g.gain.value=0.05; o.connect(g).connect(c.destination); const t=c.currentTime; o.start(t); o.stop(t+0.08); voiceReady=true; }catch(_){ } }
function speakQueued(text, next){
  if(!voiceReady) unlockTTS(); ensureAudio();
  try{
    const u=new SpeechSynthesisUtterance(String(text));
    u.lang='ja-JP'; u.rate=0.85; u.pitch=1; u.volume=1;
    const vs=speechSynthesis.getVoices?.()||[];
    const ja=vs.find(v=>(v.lang||'').toLowerCase().startsWith('ja')); if(ja) u.voice=ja;
    let settled=false; const proceed=()=>{ if(settled) return; settled=true; next?.(); };
    const timeoutMs = Math.max(1600, Math.min(8000, text.length*180));
    const to = setTimeout(proceed, timeoutMs);
    u.onend = ()=>{ clearTimeout(to); proceed(); };
    u.onerror = ()=>{ clearTimeout(to); proceed(); };
    speechSynthesis.speak(u);
  }catch(_){ next?.(); }
}
function beep(ms=140,f=880){ try{ ensureAudio(); const c=getCtx(),o=c.createOscillator(),g=c.createGain(); g.gain.setValueAtTime(0.08,c.currentTime); o.frequency.value=f; o.connect(g).connect(c.destination); o.start(); o.stop(c.currentTime+ms/1000); }catch(_){ } }
let toastTimer=null; function toast(msg){ $toast.textContent=msg; $toast.style.display='block'; clearTimeout(toastTimer); toastTimer=setTimeout(()=>{$toast.style.display='none';},2200); }
let q=[]; let playing=false;
function enqueueSpeech(items){ if(!items||!items.length) return; q.push(...items); if(!playing) playNext(); }
function playNext(){ if(!q.length){ playing=false; return; } playing=true; const text=q.shift(); toast(text); beep(130,880); speakQueued(text, ()=>{ setTimeout(playNext, 120); }); }

/* ====== Wake Lockï¼ˆç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼‰ ====== */
let wakeLock = null;
async function enableWakeLock(){
  try{
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      $keepAwake.textContent = 'ç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢: ON';
      wakeLock.addEventListener('release', ()=> { $keepAwake.textContent = 'ç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢: OFF'; });
    } else {
      alert('ç«¯æœ«ãŒ Wake Lock ã«æœªå¯¾å¿œã§ã™ã€‚iPhoneå´ã®è‡ªå‹•ãƒ­ãƒƒã‚¯ã‚’ã€Œã—ãªã„ã€ã«ã—ã¦ãã ã•ã„ã€‚');
    }
  }catch(e){
    console.warn('WakeLock error:', e);
    alert('Wake Lock ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚iPhoneå´ã®è‡ªå‹•ãƒ­ãƒƒã‚¯ã‚’ã€Œã—ãªã„ã€ã«ã—ã¦ãã ã•ã„ã€‚');
  }
}
async function disableWakeLock(){ try{ await wakeLock?.release(); }catch(_){}
  wakeLock = null; $keepAwake.textContent = 'ç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢: OFF'; }
document.addEventListener('visibilitychange', ()=> { if (document.visibilityState === 'visible' && wakeLock) enableWakeLock(); });
$keepAwake.onclick = ()=> { if (wakeLock) disableWakeLock(); else enableWakeLock(); };

/* ====== ãƒ¡ãƒ¢æŠ½å‡ºï¼ˆMyMapsã®description/ExtendedDataç­‰ï¼‰ ====== */
function stripHtml(x){ if (!x) return ''; const div=document.createElement('div'); div.innerHTML=String(x); return (div.textContent||div.innerText||'').replace(/\s+/g,' ').trim(); }
function firstNonEmpty(arr){ for(const v of arr){ if(v!=null && String(v).trim()!=='') return v; } return ''; }
function extractMemo(props){
  if(!props || typeof props!=='object') return '';
  const direct = firstNonEmpty([props.memo, props.Memo, props.description, props.Description, props.snippet, props.Snippet, props.note, props.Note, props['ãƒ¡ãƒ¢'], props['èª¬æ˜'], props['æ¦‚è¦']]);
  if (direct) return stripHtml(direct);
  const ed = props.ExtendedData || props.extendedData || props.extendeddata || {};
  try{ const arr = Array.isArray(ed.Data)? ed.Data : Array.isArray(ed.data)? ed.data : null;
    if (arr) for(const item of arr){ const k=item?.name||item?.Name||''; const v=item?.value||item?.Value||''; if(/desc|memo|note|èª¬æ˜|æ¦‚è¦/i.test(k)&&stripHtml(v)) return stripHtml(v); } }catch(_){}
  try{ const sds = ed.SchemaData || ed.schemadata || [];
    for(const s of (Array.isArray(sds)?sds:[sds])){ const sims = s?.SimpleData || s?.simpledata || [];
      for(const sd of (Array.isArray(sims)?sims:[sims])){ const k=sd?.name||sd?.Name||''; const v=sd?._text||sd?.text||sd?.value||''; if(/desc|memo|note|èª¬æ˜|æ¦‚è¦/i.test(k)&&stripHtml(v)) return stripHtml(v); } } }catch(_){}
  try{ for(const k of Object.keys(ed)){ const v=ed[k]; if(/desc|memo|note|èª¬æ˜|æ¦‚è¦/i.test(k)&&stripHtml(v)) return stripHtml(v); } }catch(_){}
  const htmlish = firstNonEmpty([props.descriptionHtml, props.balloonText, props.BalloonText]); if (htmlish) return stripHtml(htmlish);
  return '';
}

/* ====== KML/KMZ èª­ã¿è¾¼ã¿ ====== */
function clearRoute(){ if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; } routePointLayers.length=0; genericPointLayers.length=0; $fname.textContent='ï¼ˆæœªé¸æŠï¼‰'; }
document.getElementById('clear').onclick=clearRoute;

$file.addEventListener('change', async (ev)=>{
  const f=ev.target.files?.[0]; if(!f) return; $fname.textContent=f.name;
  try{
    let kmlText=null;
    if(/\.kmz$/i.test(f.name)){
      const buf=await f.arrayBuffer();
      const zip=await JSZip.loadAsync(buf);
      const ent=Object.values(zip.files).find(z=>z.name.toLowerCase().endsWith('.kml'));
      if(!ent){ alert('KMZå†…ã«KMLãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      kmlText=await ent.async('string');
    }else{
      kmlText=await f.text();
    }
    const dom=new DOMParser().parseFromString(kmlText,'text/xml');
    const gj=toGeoJSON.kml(dom);

    if(routeLayer) map.removeLayer(routeLayer);

    routeLayer=L.geoJSON(gj,{
      style:{color:'#1d4ed8',weight:4},

      /* Pointã‚’åˆ†é¡ï¼šæ¡ç”¨ï¼ˆé’ï¼‰/ æ±ç”¨ï¼ˆç°ï¼‰ */
      pointToLayer:(feat,latlng)=>{
        const props = feat.properties || {};
        const name  = (props.name || props.Name || '').trim();
        const memo  = extractMemo(props).trim();
        const generic = /^(point|ãƒã‚¤ãƒ³ãƒˆ|çµŒç”±åœ°|waypoint|via)(?:[\s\-_\d]*)$/i.test(name);

        const isMeaningful = !!( memo || (name && !generic) );
        const icon = isMeaningful ? window.__BlueIcon : window.__GrayIcon;
        const popup = (name||memo)? [name,memo].filter(Boolean).join('<br>') : (generic?'ãƒ«ãƒ¼ãƒˆç”¨ãƒ”ãƒ³':'ãƒã‚¤ãƒ³ãƒˆ');

        const m=L.marker(latlng,{icon}).bindPopup(popup);
        m.feature={properties:{name, memo}};
        m._announced=false; m._lastDist=Infinity;

        if(isMeaningful){
          routePointLayers.push(m);   // â† èª­ã¿ä¸Šã’å¯¾è±¡
        }else{
          genericPointLayers.push(m); // â† è¡¨ç¤ºã®ã¿
        }
        return m;
      }
    }).addTo(map);

    try{ map.fitBounds(routeLayer.getBounds(),{padding:[20,20]}); }catch(_){}
    if(tracking && lastLatLng) checkNearAndSpeak(L.latLng(lastLatLng));
  }catch(e){ alert('ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ã«å¤±æ•—ï¼š'+(e?.message||e)); }
});

/* ====== åˆ¤å®šï¼šåŠå¾„å†…ã‚’è·é›¢é †ã§èª­ã‚€ï¼ˆæ„å‘³ã®ã‚ã‚‹ãƒã‚¤ãƒ³ãƒˆï¼‹æ‰‹å‹•CPã®ã¿ï¼‰ ====== */
function collectNearTexts(here){
  const list=[...routePointLayers, ...Object.values(checkpointLayer._layers||{})]; // æ±ç”¨ãƒ«ãƒ¼ãƒˆãƒ”ãƒ³ã¯å«ã‚ãªã„
  const hits=[];
  for(const layer of list){
    if(!layer?.getLatLng || layer._announced) continue;
    const dist=map.distance(here, layer.getLatLng());
    layer._lastDist=dist;
    const p=layer.feature?.properties||{};
    const name=(p.name||'').trim();
    const memo=(p.memo||'').trim();
    if(dist<=notifyMeters){
      const memoShort = memo.length>100 ? memo.slice(0,100)+'â€¦' : memo;
      const text=(name||memoShort)?[name,memoShort].filter(Boolean).join('ã€‚'):'ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ';
      hits.push({dist,text,layer});
    }
  }
  if(!hits.length) return [];
  hits.sort((a,b)=>a.dist-b.dist);
  hits.forEach(h=>h.layer._announced=true);
  return hits.map(h=>h.text);
}
function checkNearAndSpeak(here){
  const texts=collectNearTexts(here);
  if(texts.length) enqueueSpeech(texts);
}

/* ====== é€²è¡Œæ–¹å‘ï¼ˆæ–¹ä½ï¼‰ã¨åœ°å›³å›è»¢ ====== */
let currentBearing=0; // 0 = åŒ—ä¸Š
function bearingBetween(a,b){
  const toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;
  const lat1=toRad(a.lat), lon1=toRad(a.lng), lat2=toRad(b.lat), lon2=toRad(b.lng);
  const y=Math.sin(lon2-lon1)*Math.cos(lat2);
  const x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(lon2-lon1);
  let brng=(toDeg(Math.atan2(y,x))+360)%360;
  return brng;
}
function rotateMap(bearingDeg){
  // Leafletæœ¬ä½“ã¯å›è»¢éå¯¾å¿œãªã®ã§ã€ç”»é¢ã‚’CSSã§å›ã™ï¼ˆè¦‹ãŸç›®ä¸Šã®å›è»¢ï¼‰
  const pane = map.getPanes().mapPane; // .leaflet-map-pane
  pane.style.transform = `rotate(${-bearingDeg}deg)`;
  // ã‚³ãƒ³ãƒ‘ã‚¹ã®çŸ¢å°ã¯åŒ—ã‚’æŒ‡ã™ã®ã§ã€åœ°å›³ã«åˆã‚ã›ã¦é€†å›è»¢ã¯ä¸è¦ã€‚é€²è¡Œæ–¹å‘ã‚’ä¸Šã«ã™ã‚‹ã¨ãã¯çŸ¢å°ã¯ bearing ã«å›ã™
  $compassArrow.style.transform = `rotate(${bearingDeg}deg)`;
}

/* ====== UIæ“ä½œ ====== */
document.getElementById('tts').onclick=()=>{ unlockTTS(); enqueueSpeech(['ãƒ†ã‚¹ãƒˆã§ã™']); };
$th.oninput=()=>{ notifyMeters=+$th.value; $thv.textContent=`${notifyMeters}m`; };

$track.onclick=()=>{
  if(tracking) return;
  unlockTTS();

  tracking=true;
  $track.disabled=true; $stop.disabled=false;
  $recBadge.style.display='flex'; startPulse();
  trackLine.setLatLngs([]); checkpointLayer.clearLayers();

  enqueueSpeech(['è©•ä¾¡ã‚’é–‹å§‹ã—ã¾ã™']);
  if(lastLatLng){
    const texts=collectNearTexts(L.latLng(lastLatLng));
    if(texts.length) enqueueSpeech(texts);
  }

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const ll=[pos.coords.latitude,pos.coords.longitude];
      prevLatLng=lastLatLng? L.latLng(lastLatLng): null;
      lastLatLng=ll;
      me.setLatLng(lastLatLng);
      map.setView(lastLatLng,16);
      checkNearAndSpeak(L.latLng(lastLatLng));
    },()=>{}, {enableHighAccuracy:true,timeout:8000});
  }

  let sweep=0; clearInterval(startupSweepTimer);
  startupSweepTimer=setInterval(()=>{
    if(!tracking){ clearInterval(startupSweepTimer); return; }
    if(lastLatLng) checkNearAndSpeak(L.latLng(lastLatLng));
    if(++sweep>=10) clearInterval(startupSweepTimer);
  },2000);

  watchId=navigator.geolocation.watchPosition(pos=>{
    prevLatLng = lastLatLng? L.latLng(lastLatLng): null;
    lastLatLng=[pos.coords.latitude,pos.coords.longitude];
    const here=L.latLng(lastLatLng);
    me.setLatLng(here);
    trackLine.addLatLng(here);

    // é€²è¡Œæ–¹å‘ï¼ˆå„ªå…ˆï¼šç«¯æœ«ã® headingã€ç„¡ã‘ã‚Œã°ç§»å‹•ãƒ™ã‚¯ãƒˆãƒ«ã‹ã‚‰è¨ˆç®—ï¼‰
    let bearing = (typeof pos.coords.heading==='number' && !isNaN(pos.coords.heading)) ? pos.coords.heading : (prevLatLng? bearingBetween(prevLatLng, here): currentBearing);
    currentBearing = bearing;

    if(orientationMode==='course'){
      rotateMap(bearing);
      $compass.style.display='grid';
    }else{
      rotateMap(0);
      $compass.style.display='none';
    }

    if($keepCentered.checked){
      map.setView(here, map.getZoom(), {animate:false});
    }

    checkNearAndSpeak(here);
  },err=>{ $stat.textContent=`ä½ç½®ã‚¨ãƒ©ãƒ¼: ${err.message}`; },
  {enableHighAccuracy:true,maximumAge:1000,timeout:10000});
};

$stop.onclick=()=>{
  if(!tracking) return;
  tracking=false;

  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  clearInterval(startupSweepTimer);

  $track.disabled=false; $stop.disabled=true;
  $recBadge.style.display='none'; stopPulse();

  // åœ°å›³å›è»¢ã‚’ãƒªã‚»ãƒƒãƒˆ
  rotateMap(0); $compass.style.display='none';

  unlockTTS();
  enqueueSpeech(['è©•ä¾¡ã‚’çµ‚äº†ã—ã¾ã™']);
};

$chk.onclick=()=>{
  if(!lastLatLng){ alert("ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“"); return; }
  let memo=''; if($memo.checked) memo=prompt("ãƒ¡ãƒ¢å…¥åŠ›ï¼ˆä»»æ„ï¼‰","");
  const m=L.marker(lastLatLng,{icon:window.__OrangeIcon}).addTo(checkpointLayer);
  m.feature={properties:{name:'ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ', memo:memo||''}};
  m.bindPopup(memo?`<b>CP</b><br>${memo}`:"<b>CP</b>");
  m._announced=false; m._lastDist=Infinity;
  checkNearAndSpeak(L.latLng(lastLatLng)); // è¿½åŠ ç›´å¾Œã«åŠå¾„å†…ãªã‚‰èª­ã‚€
};

$rec.onclick=()=>{ if(lastLatLng) map.setView(lastLatLng,16); };
$fab.onclick=()=>$rec.click();

/* ====== æ¼”å‡º ====== */
function startPulse(){ let up=true; pulseTimer=setInterval(()=>{ let r=me.options.radius; r=up?Math.min(11,r+0.5):Math.max(7,r-0.5); me.setStyle({radius:r}); if(r>=11)up=false; if(r<=7)up=true; },80); }
function stopPulse(){ clearInterval(pulseTimer); pulseTimer=null; me.setStyle({radius:7}); }

/* åˆå›ä½ç½®ï¼ˆåœ°å›³å¯„ã›ï¼‰ */
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    lastLatLng=[pos.coords.latitude,pos.coords.longitude];
    me.setLatLng(lastLatLng); map.setView(lastLatLng,16);
  },()=>{});
}

/* ====== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆGeoJSONï¼‰ ====== */
document.getElementById('export').onclick=()=>{
  const gj={type:'FeatureCollection',features:[
    {type:'Feature',properties:{kind:'track'},geometry:{type:'LineString',coordinates:trackLine.getLatLngs().map(ll=>[ll.lng,ll.lat])}}
  ]};
  Object.values(checkpointLayer._layers||{}).forEach(m=>{
    const p=m.feature?.properties||{};
    gj.features.push({type:'Feature',properties:{kind:'checkpoint',...p},geometry:{type:'Point',coordinates:[m.getLatLng().lng,m.getLatLng().lat]}});
  });
  const blob=new Blob([JSON.stringify(gj,null,2)],{type:'application/geo+json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`route_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.geojson`;
  a.click(); URL.revokeObjectURL(a.href);
};
</script>
</body>
</html>
