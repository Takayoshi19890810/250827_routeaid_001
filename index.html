<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>実車評価支援ツール</title>
<link rel="stylesheet" href="leaflet.css" />
<style>
  html,body{height:100%;margin:0}
  #map{position:fixed; inset:0; background:#f2f2f2; transform-origin:center center; z-index:0;}
  #panel{
    position:fixed; left:10px; top:calc(10px + env(safe-area-inset-top));
    z-index:2147483000; background:#fff; padding:10px 12px; border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.18); font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    min-width:300px; max-width:min(94vw,560px)
  }
  #panel h1{margin:0 0 8px;font-size:15px;font-weight:700}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  .row>label{white-space:nowrap}
  .small{font-size:11px;color:#555}
  .grow{flex:1 1 auto;min-width:140px}
  button{padding:10px 14px; min-height:40px; border-radius:12px; cursor:pointer; border:1px solid #ddd; background:#fff;}
  select, input[type=range]{height:40px;border-radius:10px;border:1px solid #ddd;padding:0 8px}

  #fabStop{
    position:fixed; right:calc(12px + env(safe-area-inset-right)); bottom:calc(12px + env(safe-area-inset-bottom)); z-index:2147483200;
    width:64px;height:64px;border-radius:50%; display:none; place-items:center; font-weight:700;
    border:none; background:#ef4444;color:#fff;font-size:16px; box-shadow:0 8px 28px rgba(239,68,68,.5);
  }
  #fabStop:active{transform:translateY(1px)}

  /* Leaflet 調整 */
  .leaflet-control-zoom{display:none}
  .leaflet-top.leaflet-left{top:calc(60px + env(safe-area-inset-top))}
  #recenter{display:none}

  /* 状態バッジ */
  #recBadge{position:fixed; right:12px; top:calc(12px + env(safe-area-inset-top)); z-index:2147483200; display:none; align-items:center; gap:6px;
    background:rgba(239,68,68,.95); color:#fff; padding:6px 10px; border-radius:9999px; box-shadow:0 6px 24px rgba(0,0,0,.18); font-size:12px}
  .dot{width:10px;height:10px;border-radius:50%;background:#fff;animation:blink 1s infinite}
  @keyframes blink{0%,60%{opacity:1}61%,100%{opacity:.25}}

  /* トースト */
  #toast{position:fixed; left:50%; bottom:calc(78px + env(safe-area-inset-bottom)); transform:translateX(-50%); z-index:2147483100;
    display:none; max-width:min(92vw,560px); background:rgba(0,0,0,.85); color:#fff; padding:10px 14px; border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.35); font-size:14px}

  /* コンパス */
  #compass{position:fixed; right:calc(14px + env(safe-area-inset-right)); top:calc(74px + env(safe-area-inset-top));
    z-index:2147483001; width:44px;height:44px;border-radius:50%;background:#fff; box-shadow:0 4px 12px rgba(0,0,0,.2);
    display:none; place-items:center; font-size:12px;color:#111;}
  #compassArrow{width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:14px solid #ef4444;transform-origin:50% 90%}

  #fname{max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .counts{font-size:11px;color:#334155;background:#f1f5f9;border-radius:9999px;padding:2px 8px}

  /* === Menu ON/OFF === */
  #panel.hidden{ display:none; }
  #menuToggle{
    position:fixed;
    left:calc(10px + env(safe-area-inset-left));
    top:calc(10px + env(safe-area-inset-top));
    z-index:2147483300;
    width:44px;height:44px;border-radius:50%;
    background:#fff; border:1px solid #ddd;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
    font-size:20px; line-height:44px; text-align:center;
    display:none; /* hidden while panel is visible */
  }
  #panel .panelHide{
    position:absolute; right:6px; top:6px;
    width:28px; height:28px; border:0; background:transparent;
    font-size:18px; line-height:1; opacity:.65; cursor:pointer;
  }
  #panel .panelHide:hover{ opacity:1; }
</style>
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#ffffff" />
</head>
<body>
<div id="map"></div>

<div id="panel">
  <h1>実車評価支援ツール</h1>
  <button id="hidePanel" class="panelHide" aria-label="メニューを隠す">×</button>

  <!-- 複数ファイル入力 + 切替セレクタ -->
  <div class="row">
    <input type="file" id="file" accept=".kml,.kmz" multiple />
    <select id="datasetSelect" class="grow">
      <option value="" disabled selected>（読み込んだルート／ポイントを選択）</option>
    </select>
    <span id="fname" class="small"></span>
  </div>

  <div class="row">
    <button id="start">追跡開始</button>
    <button id="stop" disabled>追跡終了</button>
    <button id="recenter">現在地へ</button>
    <button id="cp" disabled>チェックポイント</button>
    <span id="counts" class="counts"></span>
  </div>

  <div class="row">
    <label for="voice">音声</label>
    <select id="voice" class="grow">
      <option value="on" selected>ON（読み上げ）</option>
      <option value="off">OFF（バイブのみ）</option>
    </select>

    <label for="ttsRate" class="small">話速: <span id="ttsRateVal">1.0</span>x</label>
    <input id="ttsRate" type="range" min="0.7" max="1.4" step="0.1" value="1.0" style="width:120px">
  </div>

  <div class="row">
    <label for="notifyRange">通知半径</label>
    <input id="notifyRange" type="range" min="50" max="300" step="10" value="120" class="grow">
    <span id="notifyRangeVal" class="small">120</span><span class="small"> m</span>
  </div>

  <div class="row">
    <label for="distanceStep">再通知距離</label>
    <input id="distanceStep" type="range" min="100" max="1000" step="50" value="300" class="grow">
    <span id="distanceStepVal" class="small">300</span><span class="small"> m</span>
  </div>

  <div class="row">
    <label for="orient">地図の向き</label>
    <select id="orient" class="grow">
      <option value="north" selected>北を上</option>
      <option value="heading">進行方向を上</option>
    </select>
  </div>

  <div class="row">
    <label for="keepAwake" class="grow"><input id="keepAwake" type="checkbox" checked> 画面オフ防止</label>
    <label for="autoCenter" class="grow"><input id="autoCenter" type="checkbox" checked> つねに自車を中心</label>
  </div>

  <div class="row">
    <button id="test">音声テスト</button>
    <button id="clear">消去</button>
    <span id="gpsStatus" class="small">GPS: -</span>
  </div>

  <div class="row">
    <label class="small" for="notifyRange">通知半径: <span id="notifyRangeValDup">120</span> m</label>
    <input id="notifyRangeDup" type="range" min="50" max="300" step="10" value="120" style="width:180px; margin-left:8px;">
  </div>

  <div class="row">
    <button id="saveGpx" disabled>GPX保存</button>
    <button id="saveGeo" disabled>GeoJSON保存</button>
    <span id="stat" class="small"></span>
  </div>
</div>

<button id="menuToggle" aria-label="メニューを表示">☰</button>

<button id="fabStop">停止</button>
<div id="recBadge"><div class="dot"></div><div>追跡中</div></div>
<div id="toast"></div>
<div id="compass"><div id="compassArrow"></div></div>

<script src="leaflet.js"></script>
<script src="jszip.min.js"></script>
<script src="togeojson.umd.js"></script>
<script>
(function(){
  /* ==== ユーティリティ ==== */
  function toast(msg, ms=2000){ $toast.textContent=msg; $toast.style.display='block'; setTimeout(()=>{$toast.style.display='none'}, ms); }
  function escapeHTML(s){ return String(s||'').replace(/[&<>\"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
  function escapeXML(s){ return escapeHTML(s); }
  function formatTs(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`; }

  /* ==== ピン定義 ==== */
  const pinStyles = { route:{color:'#1d4ed8'}, poi:{color:'#ef4444'} };

  /* ==== DOM参照 ==== */
  const $map=document.getElementById('map');
  const $file=document.getElementById('file');
  const $datasetSelect=document.getElementById('datasetSelect');
  const $fname=document.getElementById('fname');
  const $start=document.getElementById('start');
  const $stop=document.getElementById('stop');
  const $recenter=document.getElementById('recenter');
  const $cp=document.getElementById('cp');
  const $counts=document.getElementById('counts');
  const $notifyRange=document.getElementById('notifyRange');
  const $notifyRangeVal=document.getElementById('notifyRangeVal');
  const $notifyRangeDup=document.getElementById('notifyRangeDup');
  const $notifyRangeValDup=document.getElementById('notifyRangeValDup');
  const $distanceStep=document.getElementById('distanceStep');
  const $distanceStepVal=document.getElementById('distanceStepVal');
  const $voice=document.getElementById('voice');
  const $ttsRate=document.getElementById('ttsRate');
  const $ttsRateVal=document.getElementById('ttsRateVal');
  const $autoCenter=document.getElementById('autoCenter');
  const $test=document.getElementById('test');
  const $clear=document.getElementById('clear');
  const $gpsStatus=document.getElementById('gpsStatus');
  const $saveGpx=document.getElementById('saveGpx');
  const $saveGeo=document.getElementById('saveGeo');
  const $fabStop=document.getElementById('fabStop');
  const $recBadge=document.getElementById('recBadge');
  const $toast=document.getElementById('toast');
  const $compass=document.getElementById('compass');
  const $compassArrow=document.getElementById('compassArrow');

  /* ==== マップ初期化 ==== */
  const map = L.map('map', { zoomControl:false, center:[35.6812,139.7671], zoom:15 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);

  /* ==== 状態 ==== */
  let tracking=false, watchId=null, wakeLock=null, currentBearing=0;
  let routeLayer=L.layerGroup().addTo(map);
  let poiLayer=L.layerGroup().addTo(map);
  let trackLatLngs=[], trackLine=null, lastNotifyPos=null;

  /* ==== UI 初期化 ==== */
  $notifyRangeVal.textContent = $notifyRange.value;
  $notifyRangeValDup.textContent = $notifyRangeDup.value;
  $notifyRange.addEventListener('input', ()=>{$notifyRangeVal.textContent=$notifyRange.value; $notifyRangeDup.value=$notifyRange.value; $notifyRangeValDup.textContent=$notifyRange.value;});
  $notifyRangeDup.addEventListener('input', ()=>{$notifyRangeValDup.textContent=$notifyRangeDup.value; $notifyRange.value=$notifyRangeDup.value; $notifyRangeVal.textContent=$notifyRange.value;});
  $distanceStep.addEventListener('input', ()=>{$distanceStepVal.textContent=$distanceStep.value;});
  $ttsRate.addEventListener('input', ()=>{$ttsRateVal.textContent=(+$ttsRate.value).toFixed(1);});

  /* ==== 自車マーカー ==== */
  const carIcon=L.divIcon({className:"", html:`<div style="width:16px;height:16px;border-radius:50%;background:#ef4444;border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.15)"></div>`});
  let me=null;

  function setHeading(bearingDeg){
    currentBearing=bearingDeg||0;
    $compass.style.display='grid';
    $compassArrow.style.transform=`rotate(${currentBearing}deg)`;
  }

  /* ==== TTS ==== */
  let ttsQueue=[],speaking=false,jpVoice=null,ttsUnlocked=false;
  function unlockTTS(){ if(ttsUnlocked) return; ttsUnlocked=true; jpVoice=(speechSynthesis.getVoices().find(v=>/ja-JP|japan/i.test(v.lang))||speechSynthesis.getVoices()[0]||null); }
  speechSynthesis.addEventListener('voiceschanged',unlockTTS);
  function enqueueSpeech(lines){ for(const s of lines){ const u=new SpeechSynthesisUtterance(s); u.voice=jpVoice; u.rate=+$ttsRate.value; u.pitch=1.0; ttsQueue.push(u);} if(!speaking)speakNext(); }
  function speakNext(){ if(!ttsQueue.length){speaking=false;return;} speaking=true; const u=ttsQueue.shift(); u.onend=()=>speakNext(); speechSynthesis.speak(u); }

  /* ==== KML/KMZ 読み込み ==== */
  async function parseFile(file){
    const name=file.name.toLowerCase();
    if(name.endsWith('.kml')){ return parseKml(await file.text()); }
    if(name.endsWith('.kmz')){
      const zip=await JSZip.loadAsync(await file.arrayBuffer());
      const kmlEntry=Object.values(zip.files).find(f=>f.name.toLowerCase().endsWith('.kml'));
      if(!kmlEntry) throw new Error('KMZにKMLが見つかりません');
      return parseKml(await kmlEntry.async('text'));
    }
    throw new Error('対応拡張子は .kml / .kmz です');
  }

  function parseKml(kmlString){
    const dom=(new DOMParser()).parseFromString(kmlString,'text/xml');
    const gj=toGeoJSON.kml(dom);
    const routes=[], pois=[];

    function pushGeom(g, props){
      if(!g) return;
      if(g.type==='Point') pois.push({type:'Feature', properties:props||{}, geometry:g});
      else if(g.type==='LineString') routes.push({type:'Feature', properties:props||{}, geometry:g});
      else if(g.type==='MultiLineString') for(const c of g.coordinates) routes.push({type:'Feature', properties:props||{}, geometry:{type:'LineString', coordinates:c}});
      else if(g.type==='GeometryCollection') for(const gg of (g.geometries||[])) pushGeom(gg, props);
      // Polygon等は今回の用途では無視
    }

    for(const f of gj.features){ if(f && f.geometry) pushGeom(f.geometry, f.properties||{}); }
    return {routes, pois};
  }

  let datasets=[]; // {name, routes, pois}
  $file.addEventListener('change', async ()=>{
    datasets=[];
    $datasetSelect.innerHTML='<option value="" disabled selected>（読み込んだルート／ポイントを選択）</option>';
    for(const f of $file.files){
      try{
        const parsed=await parseFile(f);
        datasets.push({name:f.name, ...parsed});
        const opt=document.createElement('option'); opt.value=String(datasets.length-1); opt.textContent=f.name; $datasetSelect.appendChild(opt);
      }catch(e){ toast(`${f.name}: ${e.message||e}`); }
    }
    if(datasets.length>0){ $datasetSelect.value='0'; $datasetSelect.dispatchEvent(new Event('change')); }
    toast(`${datasets.length}件 読み込み完了`);
  });

  $datasetSelect.addEventListener('change', ()=>{
    const idx=+$datasetSelect.value; const ds=datasets[idx];
    $fname.textContent=ds?ds.name:''; renderDataset(ds);
  });

  function renderDataset(ds){
    routeLayer.clearLayers(); poiLayer.clearLayers(); if(!ds) return;
    const added=[];
    for(const r of ds.routes){
      if(r.geometry && r.geometry.type==='LineString'){
        const latlngs=r.geometry.coordinates.map(([lng,lat])=>[lat,lng]);
        const pl=L.polyline(latlngs,{color:pinStyles.route.color,weight:4,opacity:.9}).addTo(routeLayer); added.push(pl);
      }
    }
    for(const p of ds.pois){
      if(!p.geometry||!p.geometry.coordinates) continue; const [lng,lat]=p.geometry.coordinates;
      const m=L.circleMarker([lat,lng],{radius:6,color:pinStyles.poi.color,weight:2,fillColor:'#fff',fillOpacity:1});
      const name=(p.properties&&(p.properties.name||p.properties.Name||p.properties.title))||'評価ポイント';
      const desc=(p.properties&&(p.properties.description||p.properties.Description||''))||'';
      m.bindPopup(`<b>${escapeHTML(name)}</b><div style="margin-top:4px">${escapeHTML(desc)}</div>`);
      m.feature={kind:'poi', name, desc}; m.addTo(poiLayer); added.push(m);
    }
    if(added.length){ try{ map.fitBounds(L.featureGroup(added).getBounds().pad(0.2)); }catch(_){} }
    $counts.textContent=`ポイント:${ds.pois.length}  ルート:${ds.routes.length}`;
  }

  /* ==== 追跡 ==== */
  function startTracking(){
    if(tracking) return; tracking=true;
    $start.disabled=true; $stop.disabled=false; $cp.disabled=false; $recenter.style.display='inline-block';
    $fabStop.style.display='grid'; $recBadge.style.display='flex'; enqueueSpeech(['追跡を開始します']);
    if('wakeLock' in navigator){ navigator.wakeLock.request('screen').then(l=>wakeLock=l).catch(()=>{}); }
    watchId=navigator.geolocation.watchPosition(onPos,onErr,{enableHighAccuracy:true,maximumAge:1000,timeout:15000});
  }
  function stopTracking(){
    if(!tracking) return; tracking=false;
    $start.disabled=false; $stop.disabled=true; $cp.disabled=true; $recenter.style.display='none';
    $fabStop.style.display='none'; $recBadge.style.display='none'; enqueueSpeech(['追跡を終了します']);
    if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
    if(wakeLock){ try{wakeLock.release();}catch(_){} wakeLock=null; }
  }
  $start.addEventListener('click',startTracking);
  $stop.addEventListener('click',stopTracking);
  $fabStop.addEventListener('click',stopTracking);
  $recenter.addEventListener('click',()=>{ if(me) map.setView(me.getLatLng(), Math.max(map.getZoom(),16)); });

  function onPos(pos){
    const {latitude, longitude, speed, heading}=pos.coords; const latlng=[latitude,longitude];
    $gpsStatus.textContent=`GPS: OK  速度:${Math.round((speed||0)*3.6)}km/h`;
    if(!me){ me=L.marker(latlng,{icon:carIcon}).addTo(map); } else { me.setLatLng(latlng); }
    if($autoCenter.checked){ map.setView(latlng, Math.max(map.getZoom(),16)); }
    if(document.getElementById('orient').value==='heading' && typeof heading==='number'){ setHeading(heading); } else { $compass.style.display='none'; }

    if(lastNotifyPos){ const dx=map.distance(latlng,lastNotifyPos); if(dx>=+$distanceStep.value){ lastNotifyPos=null; } }
    notifyIfInRange(latlng);

    trackLatLngs.push(latlng);
    if(!trackLine){ trackLine=L.polyline(trackLatLngs,{color:'#111',weight:3,opacity:.8}).addTo(map); }
    else{ trackLine.setLatLngs(trackLatLngs); }
  }
  function onErr(err){ $gpsStatus.textContent=`GPS: ${err.message||err}`; toast('GPS信号が弱いです'); }

  function notifyIfInRange(latlng){
    const idx=+$datasetSelect.value; const ds=datasets[idx]; if(!ds) return; const r=+$notifyRange.value;
    let found=null; poiLayer.eachLayer(m=>{ if(map.distance(latlng,m.getLatLng())<=r) found=m; });
    if(found){ if(lastNotifyPos) return; const f=found.feature||{name:'評価ポイント',desc:''}; const lines=[`${f.name}  付近です。`];
      if($voice.value==='on') enqueueSpeech(lines); else if(navigator.vibrate) navigator.vibrate([200]); lastNotifyPos=latlng; }
  }

  /* ==== テスト・消去 ==== */
  $test.addEventListener('click',()=>{ unlockTTS(); enqueueSpeech(['音声テストです']); });
  $clear.addEventListener('click',()=>{ routeLayer.clearLayers(); poiLayer.clearLayers(); trackLatLngs=[]; if(trackLine){ map.removeLayer(trackLine); trackLine=null; } $counts.textContent=''; toast('消去しました'); });

  /* ==== 保存 ==== */
  function toGPX(){ const trk=trackLatLngs.map(([lat,lng])=>`<trkpt lat="${lat}" lon="${lng}"></trkpt>`).join(''); return `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="tool"><trk><name>track</name><trkseg>${trk}</trkseg></trk></gpx>`; }
  function toGeo(){ const features=[]; if(trackLatLngs.length){ features.push({type:'Feature',properties:{name:'track'},geometry:{type:'LineString',coordinates:trackLatLngs.map(([lat,lng])=>[lng,lat])}});} poiLayer.eachLayer(m=>{ const {lat,lng}=m.getLatLng(); const f=m.feature||{}; features.push({type:'Feature',properties:{name:f.name||'POI',desc:f.desc||''},geometry:{type:'Point',coordinates:[lng,lat]}});}); return JSON.stringify({type:'FeatureCollection',features},null,2); }
  $saveGpx.addEventListener('click',()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([toGPX()],{type:'application/gpx+xml'})); a.download=`track_${formatTs()}.gpx`; a.click(); });
  $saveGeo.addEventListener('click',()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([toGeo()],{type:'application/geo+json'})); a.download=`points_${formatTs()}.geojson`; a.click(); });
})();
</script>

<!-- メニューON/OFF用 追記スクリプト -->
<script>
(function(){
  const $panel=document.getElementById('panel');
  const $showBtn=document.getElementById('menuToggle');
  const $hideBtn=document.getElementById('hidePanel');
  function setPanelHidden(hidden){ $panel.classList.toggle('hidden',hidden); $showBtn.style.display=hidden?'grid':'none'; try{localStorage.setItem('panelHidden',hidden?'1':'0');}catch(e){} }
  try{ setPanelHidden(localStorage.getItem('panelHidden')==='1'); }catch(e){}
  if($hideBtn) $hideBtn.addEventListener('click',()=>setPanelHidden(true));
  if($showBtn) $showBtn.addEventListener('click',()=>setPanelHidden(false));
  document.addEventListener('keydown',e=>{ if((e.key||'').toLowerCase()==='m') setPanelHidden(!$panel.classList.contains('hidden')); });
})();
</script>
</body>
</html>
