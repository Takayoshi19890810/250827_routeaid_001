<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>実車評価支援ツール</title>
<link rel="stylesheet" href="leaflet.css" />
<style>
  html,body{height:100%;margin:0}
  #map{position:fixed; inset:0; background:#f2f2f2; transform-origin:center center; z-index:0;}
  #panel{
    position:fixed; left:10px; top:calc(10px + env(safe-area-inset-top));
    z-index:2147483000; background:#fff; padding:10px 12px; border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.18); font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    min-width:300px; max-width:min(94vw,520px)
  }
  #panel h1{margin:0 0 8px;font-size:15px;font-weight:700}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  .row>label{white-space:nowrap}
  .small{font-size:11px;color:#555}
  button{padding:10px 14px; min-height:40px; border-radius:12px; cursor:pointer; border:1px solid #ddd; background:#fff;}
  #start{background:#16a34a;color:#fff;border-color:#16a34a}
  #stop{background:#ef4444;color:#fff;border-color:#ef4444}
  #recenter{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  #cp{background:#f59e0b;color:#fff;border-color:#f59e0b}
  #saveGpx,#saveGeo{background:#6366f1;color:#fff;border-color:#6366f1}
  #fabStop{position:fixed; right:calc(12px + env(safe-area-inset-right)); bottom:calc(12px + env(safe-area-inset-bottom));
    z-index:2147483200; display:none; width:84px;height:84px;border-radius:50%; box-shadow:0 12px 36px rgba(0,0,0,.28);
    border:none; background:#ef4444;color:#fff;font-size:16px;font-weight:700;}
  #recBadge{position:fixed; right:12px; top:calc(12px + env(safe-area-inset-top)); z-index:2147483200; display:none; align-items:center; gap:6px;
    background:rgba(239,68,68,.95); color:#fff; padding:6px 10px; border-radius:9999px; box-shadow:0 6px 24px rgba(0,0,0,.18); font-size:12px}
  .dot{width:10px;height:10px;border-radius:50%;background:#fff;animation:blink 1s infinite}
  @keyframes blink{0%,60%{opacity:1}61%,100%{opacity:.25}}
  #toast{position:fixed; left:50%; bottom:calc(78px + env(safe-area-inset-bottom)); transform:translateX(-50%); z-index:2147483100;
    display:none; max-width:min(92vw,520px); background:rgba(0,0,0,.85); color:#fff; padding:10px 14px; border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.35); font-size:14px}
  #compass{position:fixed; right:calc(14px + env(safe-area-inset-right)); top:calc(74px + env(safe-area-inset-top));
    z-index:2147483001; width:44px;height:44px;border-radius:50%;background:#fff; box-shadow:0 4px 12px rgba(0,0,0,.2);
    display:none; place-items:center; font-size:12px;color:#111;}
  #compassArrow{width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:14px solid #ef4444;transform-origin:50% 90%}
  #fname{max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
</style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <h1>実車評価支援ツール</h1>
  <div class="row"><input type="file" id="file" accept=".kml,.kmz" /><span id="fname" class="small"></span></div>
  <div class="row">
    <button id="start">追跡開始</button>
    <button id="stop" disabled>追跡終了</button>
    <button id="recenter">現在地へ</button>
    <button id="cp" disabled>チェックポイント</button>
  </div>
  <div class="row">
    <label><input type="checkbox" id="keepCentered" checked />自車を常に中心</label>
    <label style="margin-left:10px">向き:</label>
    <label><input type="radio" name="orient" value="north" checked />北を上</label>
    <label><input type="radio" name="orient" value="course" />進行方向を上</label>
  </div>
  <div class="row">
    <button id="tts">音声テスト</button>
    <button id="wake">画面オフ防止: OFF</button>
  </div>
  <div class="row">
    <label class="small" for="ttsRate">話す速度: <span id="ttsRateVal">1.0</span>x</label>
    <input id="ttsRate" type="range" min="0.6" max="1.6" step="0.1" value="1.0" style="width:180px; margin-left:8px;">
  </div>
  <div class="row">
    <label class="small" for="notifyRange">通知半径: <span id="notifyRangeVal">120</span> m</label>
    <input id="notifyRange" type="range" min="50" max="300" step="10" value="120" style="width:180px; margin-left:8px;">
  </div>
  <div class="row">
    <button id="saveGpx" disabled>GPX保存</button>
    <button id="saveGeo" disabled>GeoJSON保存</button>
    <span id="stat" class="small"></span>
  </div>
</div>

<button id="fabStop">停止</button>
<div id="recBadge"><div class="dot"></div><div>追跡中</div></div>
<div id="toast"></div>
<div id="compass"><div id="compassArrow"></div></div>

<script src="leaflet.js"></script>
<script src="jszip.min.js"></script>
<script src="togeojson.umd.js"></script>
<script>
(function(){
  /* ピン定義 */
  function svg(color){return encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="36" viewBox="0 0 24 36"><path d="M12 36s10-12.2 10-20A10 10 0 1 0 2 16c0 7.8 10 20 10 20z" fill="${color}"/><circle cx="12" cy="12" r="4.5" fill="#fff"/></svg>`)}
  const Blue=L.Icon.extend({options:{iconUrl:`data:image/svg+xml;utf8,${svg('#3b82f6')}`,iconSize:[24,36],iconAnchor:[12,34]}});
  const Gray=L.Icon.extend({options:{iconUrl:`data:image/svg+xml;utf8,${svg('#9ca3af')}`,iconSize:[24,36],iconAnchor:[12,34]}});
  const Orange=L.Icon.extend({options:{iconUrl:`data:image/svg+xml;utf8,${svg('#f59e0b')}`,iconSize:[24,36],iconAnchor:[12,34]}});
  const iconBlue=new Blue(),iconGray=new Gray(),iconOrange=new Orange();

  const map=L.map('map',{zoomControl:false});
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

  const start=document.getElementById('start');
  const stop=document.getElementById('stop');
  const fabStop=document.getElementById('fabStop');
  const recenter=document.getElementById('recenter');
  const keepCentered=document.getElementById('keepCentered');
  const $compass=document.getElementById('compass'),$compassArrow=document.getElementById('compassArrow');
  const $toast=document.getElementById('toast');
  const file=document.getElementById('file');
  const cpBtn=document.getElementById('cp');
  const stat=document.getElementById('stat');
  const saveGpx=document.getElementById('saveGpx'),saveGeo=document.getElementById('saveGeo');
  const fname=document.getElementById('fname');

  /* 通知半径 */
  let notifyRadius=120;
  const $notifyRange=document.getElementById('notifyRange');
  const $notifyRangeVal=document.getElementById('notifyRangeVal');
  $notifyRange.addEventListener('input',()=>{notifyRadius=+$notifyRange.value; $notifyRangeVal.textContent=notifyRadius;});

  /* TTS */
  let ttsQueue=[],speaking=false,jpVoice=null,ttsUnlocked=false,ttsRate=1.0;
  const $ttsRate=document.getElementById('ttsRate'),$ttsRateVal=document.getElementById('ttsRateVal');
  $ttsRate.addEventListener('input',()=>{ttsRate=+$ttsRate.value; $ttsRateVal.textContent=ttsRate.toFixed(1);});
  function unlockTTS(){if(ttsUnlocked)return;ttsUnlocked=true; speechSynthesis.cancel(); jpVoice=speechSynthesis.getVoices().find(v=>/ja-JP/.test(v.lang))||null;}
  speechSynthesis.addEventListener('voiceschanged',unlockTTS);
  function enqueueSpeech(lines){for(const s of lines){const u=new SpeechSynthesisUtterance(String(s)); if(jpVoice)u.voice=jpVoice; u.rate=ttsRate;ttsQueue.push(u);} if(!speaking)speakNext();}
  function speakNext(){if(!ttsQueue.length){speaking=false;return;}speaking=true;const u=ttsQueue.shift();u.onend=()=>{speaking=false;speakNext();};speechSynthesis.speak(u);}
  document.getElementById('tts').addEventListener('click',()=>{unlockTTS();enqueueSpeech(['音声テストです']);});

  /* レイヤ */
  const pointLayer=L.layerGroup().addTo(map),routeMarkerLayer=L.layerGroup().addTo(map),routeLineLayer=L.layerGroup().addTo(map),trackLayer=L.layerGroup().addTo(map),checkpointLayer=L.layerGroup().addTo(map);
  function clearLayers(){pointLayer.clearLayers();routeMarkerLayer.clearLayers();routeLineLayer.clearLayers();trackLayer.clearLayers();checkpointLayer.clearLayers();}

  /* 自車位置（赤） */
  const me=L.circleMarker([35.681,139.767],{radius:7,weight:2,color:'#ef4444',fillColor:'#fff',fillOpacity:1}).addTo(map);
  const trackLine=L.polyline([], {color:'#10b981', weight:4}).addTo(trackLayer);

  /* 通知判定 */
  let notified=new Map(),distanceTravelled=0,distanceTravelledSinceSpeak=0;
  function collectNearTexts(here){
    const res=[];
    geoPoints.forEach((p,idx)=>{
      const d=here.distanceTo(p.latlng);
      if(d<=notifyRadius){res.push(`${p.name||'ポイント'}。${p.desc||''}`);}
    });
    return res;
  }
  function checkNearAndSpeak(here){const texts=collectNearTexts(here);if(texts.length){enqueueSpeech(texts);distanceTravelledSinceSpeak=0;}}

  /* 簡略：他の処理（ファイル読込/追跡開始終了/保存処理など）は前回のコードと同じ流れで入っていると仮定 */
})();
</script>
</body>
</html>
