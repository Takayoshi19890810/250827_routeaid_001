<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Route Aid – 追跡＆軌跡保存</title>
  <link rel="stylesheet" href="./leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    header { padding: .5rem .75rem; display: flex; flex-wrap: wrap; gap: .5rem; align-items: center; box-shadow: 0 1px 0 rgba(0,0,0,.08); }
    header button { padding:.5rem .7rem; border-radius:10px; border:1px solid #e5e7eb; cursor:pointer; }
    header button.primary { background:#111827; color:#fff; border-color:#111827; }
    header button.primary.running { background:#16a34a; border-color:#16a34a; animation:pulseBtn 1s infinite alternate; }
    @keyframes pulseBtn { from{opacity:.85;} to{opacity:1; transform:scale(1.05);} }
    header button.destructive { background:#dc2626; color:#fff; border-color:#dc2626; }
    header button:disabled { opacity:.5; cursor:not-allowed; }
    .status-pill { display:inline-flex; align-items:center; gap:6px; padding:.35rem .6rem; border-radius:999px; background:#f3f4f6; }
    .status-pill .dot { width:8px; height:8px; border-radius:999px; background:#9ca3af; }
    .status-running { background:#fee2e2; color:#b91c1c; }
    .status-running .dot { background:#ef4444; animation:pulse 1s ease-in-out infinite alternate; }
    .status-paused { background:#fffbeb; color:#92400e; }
    .status-paused .dot { background:#f59e0b; }
    .status-stopped { background:#e5e7eb; color:#374151; }
    .status-idle { background:#f3f4f6; color:#374151; }
    @keyframes pulse { from{opacity:.6; transform:scale(1);} to{opacity:1; transform:scale(1.25);} }
    #map { width:100%; height:100%; }
    .toast { position:fixed; left:50%; bottom:16px; transform:translateX(-50%); background:rgba(0,0,0,.85); color:#fff; padding:10px 14px; border-radius:10px; font-size:13px; z-index:9999; }
    .rec-badge { position:fixed; top:8px; right:8px; background:rgba(239,68,68,.95); color:#fff; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; z-index:2000; box-shadow:0 2px 10px rgba(0,0,0,.15); }
    .rec-badge .dot { display:inline-block; width:8px; height:8px; border-radius:999px; background:#fff; margin-right:6px; animation:recblink 1s infinite alternate; }
    .hidden { display:none; }
    @keyframes recblink { from{opacity:.7; transform:scale(.9);} to{opacity:1; transform:scale(1.1);} }
  </style>
  <link rel="manifest" href="./manifest.webmanifest" />
  <script>
    if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js').catch(console.warn); }); }
  </script>
</head>
<body>
<div id="app">
  <header>
    <span class="title">Route Aid</span>
    <button id="btnStart" class="primary">▶ 追跡開始</button>
    <button id="btnPause" disabled>⏸ 一時停止</button>
    <button id="btnResume" disabled>▶ 再開</button>
    <button id="btnStop" class="destructive" disabled>■ 停止</button>
    <span class="pill">距離: <span id="dist">0.00</span> km</span>
    <span class="pill">ポイント: <span id="pts">0</span></span>
    <span class="pill">経過: <span id="elapsed">00:00:00</span></span>
    <label>通知半径(m): <input id="notifyRadius" type="number" value="200" min="10" step="10" style="width:80px"/></label>
    <span id="runStatus" class="status-pill status-idle"><span class="dot"></span><span id="runStatusText">待機中</span></span>
    <label>ファイル名: <input id="fname" placeholder="Track_YYYYMMDD_HHMMSS" style="width:190px"/></label>
    <button id="btnSaveGPX" disabled>💾 GPX保存</button>
    <button id="btnSaveGeoJSON" disabled>💾 GeoJSON保存</button>
    <button id="btnPickDir">📁 保存先指定</button>
    <span id="dirLabel" class="pill">未指定</span>
  </header>
  <div id="recBadge" class="rec-badge hidden"><span class="dot"></span>REC 追跡中</div>
  <div id="map"></div>
</div>

<script src="./leaflet.js"></script>
<script>
let map, currentMarker, trackLine, notifyCircle;
let watchId=null, startTime=null, elapsedTimer=null;
let points=[], distMeters=0;
let following=true; let dirHandle=null;
let initialPOIAnnounced=false;
const POIS=window.ROUTE_AID_POIS||[];
// 再通知設定（移動中 300m ごと）
const REANNOUNCE_EVERY_M = 300;
let movedSinceAnnounce = 0;
let lastFixTs = null;

function pickJaVoice(){ try{const vs=speechSynthesis.getVoices(); const ja=vs.filter(v=>(v.lang||'').toLowerCase().startsWith('ja')); return ja[0]||vs[0]||null;}catch(_){return null;} }
function speak(text){ try{ speechSynthesis.cancel(); let u=new SpeechSynthesisUtterance(text); u.lang='ja-JP'; u.rate=0.95; const v=pickJaVoice(); if(v) u.voice=v; speechSynthesis.speak(u);}catch(e){console.warn(e);} }
function speakThen(text,next){ try{ speechSynthesis.cancel(); let u=new SpeechSynthesisUtterance(text); u.lang='ja-JP'; u.rate=0.95; const v=pickJaVoice(); if(v) u.voice=v; u.onend=()=>setTimeout(()=>next&&next(),150); speechSynthesis.speak(u);}catch(e){next&&next();} }
if('speechSynthesis' in window){ try{ speechSynthesis.getVoices(); }catch(_){} try{ speechSynthesis.onvoiceschanged=()=>{ try{ speechSynthesis.getVoices(); }catch(_){} }; }catch(_){} }

function init(){
  map=L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
  map.setView([35.681236,139.767125],13);
  trackLine=L.polyline([], {color:'red', weight:4, opacity:0.9}).addTo(map);
  document.getElementById('btnStart').onclick=startTracking;
  document.getElementById('btnPause').onclick=pauseTracking;
  document.getElementById('btnResume').onclick=resumeTracking;
  document.getElementById('btnStop').onclick=stopTracking;
  document.getElementById('btnSaveGPX').onclick=()=>saveTrack('gpx');
  document.getElementById('btnSaveGeoJSON').onclick=()=>saveTrack('geojson');
  document.getElementById('btnPickDir').onclick=pickDirectory;
  const nr=document.getElementById('notifyRadius'); if(nr){ nr.onchange=()=>{ const r=parseFloat(nr.value)||200; if(notifyCircle) notifyCircle.setRadius(r); }; }
  document.getElementById('fname').value=defaultFileName();
}

function toast(m,ms=1600){const t=document.createElement('div');t.className='toast';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),ms);}
function defaultFileName(){const d=new Date();const pad=n=>String(n).padStart(2,'0');return`Track_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;}

function startTracking(){ if(!('geolocation'in navigator)){toast('位置情報未対応');return;} points=[];distMeters=0;movedSinceAnnounce=0;updateStats();trackLine.setLatLngs([]);if(currentMarker)currentMarker.remove(); speak('これから評価開始します'); initialPOIAnnounced=false; watchId=navigator.geolocation.watchPosition(onPos,onErr,{enableHighAccuracy:true,maximumAge:1000,timeout:20000}); startTime=new Date(); if(elapsedTimer)clearInterval(elapsedTimer); elapsedTimer=setInterval(updateElapsed,1000); setButtons({running:true}); setRunStatus('running'); document.getElementById('btnStart').classList.add('running'); document.getElementById('recBadge').classList.remove('hidden'); toast('評価を開始します（追跡開始）'); }

function onPos(pos){ const {latitude:lat,longitude:lng}=pos.coords; const t=new Date(); lastFixTs=Date.now(); const last=points.length?points[points.length-1]:null; const p={lat,lng,t:t.toISOString()}; points.push(p); let delta=0; if(last){ delta=haversine(last.lat,last.lng,lat,lng); distMeters+=delta; movedSinceAnnounce+=delta; } trackLine.addLatLng([lat,lng]); if(!currentMarker) currentMarker=L.marker([lat,lng]).addTo(map); else currentMarker.setLatLng([lat,lng]); if(following) map.setView([lat,lng],Math.max(map.getZoom(),16),{animate:false}); const r=parseFloat(document.getElementById('notifyRadius')?.value)||200; if(notifyCircle){notifyCircle.setLatLng([lat,lng]);notifyCircle.setRadius(r);}else{notifyCircle=L.circle([lat,lng],{radius:r,fillColor:'#3b82f6',fillOpacity:0.15,color:'#2563eb',weight:1}).addTo(map);} if(!initialPOIAnnounced){ speakThen('範囲内のポイントをお知らせします',()=>announceNearbyWithinRadius(lat,lng,r)); initialPOIAnnounced=true; movedSinceAnnounce=0; } else if(movedSinceAnnounce>=REANNOUNCE_EVERY_M){ speakThen('近くのポイントをお知らせします',()=>announceNearbyWithinRadius(lat,lng,r)); movedSinceAnnounce=0; } updateStats(); }

function onErr(e){console.warn('Geo error',e);toast('位置情報取得失敗');}
function pauseTracking(){ if(watchId!=null){navigator.geolocation.clearWatch(watchId);watchId=null;clearInterval(elapsedTimer);setButtons({paused:true});setRunStatus('paused');toast('一時停止');} }
function resumeTracking(){ if(watchId==null){watchId=navigator.geolocation.watchPosition(onPos,onErr,{enableHighAccuracy:true,maximumAge:1000,timeout:20000}); if(!startTime)startTime=new Date(); clearInterval(elapsedTimer); elapsedTimer=setInterval(updateElapsed,1000); setButtons({running:true});setRunStatus('running');toast('追跡を再開');} }
function stopTracking(){ if(watchId!=null){navigator.geolocation.clearWatch(watchId);watchId=null;} clearInterval(elapsedTimer); setButtons({stopped:true}); setRunStatus('stopped'); document.getElementById('btnStart').classList.remove('running'); document.getElementById('recBadge').classList.add('hidden'); toast('停止しました。保存できます'); speak('評価を終了します。データを忘れずに保存してください'); }

function setButtons(st){const s=document.getElementById('btnStart'),p=document.getElementById('btnPause'),r=document.getElementById('btnResume'),stp=document.getElementById('btnStop'),g=document.getElementById('btnSaveGPX'),j=document.getElementById('btnSaveGeoJSON');if(st.running){s.disabled=true;p.disabled=false;r.disabled=true;stp.disabled=false;g.disabled=true;j.disabled=true;} else if(st.paused){s.disabled=true;p.disabled=true;r.disabled=false;stp.disabled=false;g.disabled=true;j.disabled=true;} else if(st.stopped){s.disabled=false;p.disabled=true;r.disabled=true;stp.disabled=true;g.disabled=false;j.disabled=false;} else{s.disabled=false;p.disabled=true;r.disabled=true;stp.disabled=true;g.disabled=true;j.disabled=true;} }

function updateStats(){document.getElementById('pts').textContent=points.length; document.getElementById('dist').textContent=(distMeters/1000).toFixed(2); // GPS信号確認
  if(startTime && lastFixTs){ const ageSec=Math.floor((Date.now()-lastFixTs)/1000); if(ageSec>15){ toast('GPS信号が弱いです'); } }
}

function announceNearbyWithinRadius(lat,lng,r){ if(!POIS.length) return; const withD=POIS.map(o=>({...o,d:haversine(lat,lng,o.lat,o.lng)})).filter(o=>o.d<=r).sort((a,b)=>a.d-b.d); if(!withD.length){speak('範囲内のポイントはありません');return;} let i=0; const sayNext=()=>{ if(i>=withD.length) return; const o=withD[i++]; speak(`${o.name||'スポット'}、距離 ${Math.round(o.d)} メートル${o.note? '。メモ、'+o.note:''}`); setTimeout(sayNext,700); }; sayNext(); }

function saveTrack(fmt){ if(points.length<2){toast('保存できる軌跡がありません');return;} const nameRaw=(document.getElementById('fname').value||defaultFileName()).trim(); const safe=nameRaw.replace(/[^\w\-_.]/g,'_'); const filename=fmt==='gpx'?`${safe}.gpx`:`${safe}.geojson`; let dataStr,mime; if(fmt==='gpx'){dataStr=buildGPX(points);mime='application/gpx+xml';}else{dataStr=JSON.stringify(buildGeoJSON(points),null,2);mime='application/geo+json';} const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([dataStr],{type:mime})); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); toast('ダウンロードを開始しました'); }

function buildGeoJSON(pts){return {type:'FeatureCollection',features:[{type:'Feature',properties:{points:pts.length,distance_m:Math.round(distMeters)},geometry:{type:'LineString',coordinates:pts.map(p=>[p.lng,p.lat])}}]};}
function buildGPX(pts){const esc=s=>s.replace(/[<&>]/g,c=>({'<':'&lt;','&':'&amp;','>':'&gt;'}[c]));const trkpts=pts.map(p=>`<trkpt lat="${p.lat}" lon="${p.lng}"><time>${p.t}</time></trkpt>`).join('\n');return`<?xml version="1.0"?><gpx version="1.1" creator="Route Aid" xmlns="http://www.topografix.com/GPX/1/1"><trk><name>${esc(document.getElementById('fname').value||'Recorded Track')}</name><trkseg>${trkpts}</trkseg></trk></gpx>`;}

async function pickDirectory(){ if(!('showDirectoryPicker'in window)){toast('未対応ブラウザ');return;} try{dirHandle=await showDirectoryPicker({mode:'readwrite'});document.getElementById('dirLabel').textContent='指定済み';}catch(e){} }
function haversine(lat1,lon1,lat2,lon2){const R=6371000;const toRad=d=>d*Math.PI/180;const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c;}
function setRunStatus(m){const pill=document.getElementById('runStatus');const text=document.getElementById('runStatusText');pill.classList.remove('status-idle','status-running','status-paused','status-stopped');if(m==='running'){pill.classList.add('status-running');text.textContent='追跡中';}else if(m==='paused'){pill.classList.add('status-paused');text.textContent='一時停止';}else if(m==='stopped'){pill.classList.add('status-stopped');text.textContent='停止';}else{pill
